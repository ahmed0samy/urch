<!DOCTYPE html>
<html>
  <head>
    <title>Admin Panel</title>
  </head>
  <body>
    <h2>Live Users</h2>
    <ul id="users"></ul>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      socket.emit("admin-join");

      const usersList = document.getElementById("users");
      const chunks = {};

      function downloadWebM(userId) {
        const blob = new Blob(chunks[userId], { type: "video/webm" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `${userId}.webm`;
        a.click();
      }

      socket.on("active-users", (users) => {
        usersList.innerHTML = "";
        users.forEach((id) => {
          const li = document.createElement("li");
          li.textContent = id;
          usersList.appendChild(li);
        });
      });

      socket.on("video-chunk", ({ userId, chunk }) => {
        if (!chunks[userId]) chunks[userId] = [];
        chunks[userId].push(new Uint8Array(chunk));
      });

      socket.on("user-disconnected", (userId) => {
        if (chunks[userId]) {
          downloadWebM(userId);
          delete chunks[userId]; // cleanup
        }
      });

      window.addEventListener("beforeunload", async (event) => {
        const ids = Object.keys(chunks);
        for (let i = 0; i < ids.length; i++) {
          downloadWebM(ids[i]);
          await new Promise((resolve) => setTimeout(resolve, 1000)); // wait 1 second
        }
      });
    </script>
  </body>
</html>
