<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel</title>
</head>
<body>
  <h2>Live Users</h2>
  <ul id="users"></ul>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    socket.emit("admin-join");

    const usersList = document.getElementById("users");
    const recorders = {};
    const chunks = {};

    function downloadWebM(userId) {
      const blob = new Blob(chunks[userId], { type: 'video/webm' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `${userId}.webm`;
      a.click();
    }

    socket.on("active-users", (users) => {
      usersList.innerHTML = "";
      users.forEach((id) => {
        const li = document.createElement("li");
        li.textContent = id;
        usersList.appendChild(li);
      });
    });

    socket.on("video-chunk", ({ userId, chunk }) => {
      if (!chunks[userId]) chunks[userId] = [];
      chunks[userId].push(new Uint8Array(chunk));
    });

    window.addEventListener("beforeunload", () => {
      for (const userId in chunks) downloadWebM(userId);
    });
  </script>
</body>
</html>
