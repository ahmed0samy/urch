<!DOCTYPE html>
<html>
  <head>
    <title>URch</title>
    <style>
      body {
        font-family: sans-serif;
        text-align: center;
        padding: 2em;
      }
      input,
      button {
        font-size: 1em;
        padding: 0.5em;
        margin: 1em;
        width: 300px;
      }
    </style>
  </head>
  <body style="background-color: #f0ebf8">
    <h2>Enter your email to begin the exam</h2>
    <input type="email" id="email" placeholder="Enter your email" required />
    <br />
    <button id="startBtn">Start Exam & Share Screen</button>
    <ul id="notes">
      <li>
        You must allow screen sharing to start the exam, and share your entire
        screen. Also, your taskbar must be visible, not hidden.
      </li>
      <li>
        Any opened tabs or windows except this one will be considered suspicious
        activity.
      </li>
      <li>
        If you have multiple monitors, please disconnect them before starting
        the exam. Using more than one monitor will lead to disqualification.
      </li>
      <li>
        Using DevTools or switching tabs will result in immediate
        disqualification.
      </li>
      <li>
        Closing the tab or refreshing the page will prevent you from continuing
        the exam.
      </li>
      <li>
        You must submit google form before the exam ends, there is no auto
        submittion.
      </li>
      <li>The exam will automatically end after 2 minutes.</li>
    </ul>
    <h3
      id="timer"
      style="
        position: fixed;
        top: 10px;
        right: 20px;
        font-size: 20px;
        color: red;
        z-index: 999;
      "
    ></h3>

    <div id="examContainer" style="display: none; height: 100vh">
      <iframe
        id="examFrame"
        src="https://docs.google.com/forms/d/e/1FAIpQLScYWRK4nplfd9NeXcr6ELkMea5FYwg83XHANGPRyWLBNS_UiA/viewform?embedded=true"
        width="100%"
        height="100%"
        frameborder="0"
        marginheight="0"
        marginwidth="0"
        style="border: none; display: block"
      >
      </iframe>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      let isSuspicious = 0;
      let monitoringStarted = false;
      const examTime = 120;
      let remainingSeconds = examTime;
      if (isMobile()) {
        document.body.innerHTML =
          "<h2>Please use a computer for this exam. Mobile is not supported.</h2>";
      }
      function isMobile() {
        return /Android|iPhone|iPad|iPod|Windows Phone/i.test(
          navigator.userAgent
        );
      }

      document.addEventListener("copy", (e) => e.preventDefault());
      document.addEventListener("cut", (e) => e.preventDefault());
      document.addEventListener("paste", (e) => e.preventDefault());
      document.addEventListener("contextmenu", (e) => e.preventDefault());
      document.addEventListener("keydown", (e) => {
        // F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U, Ctrl+S, Ctrl+Shift+C
        if (
          e.key === "F12" ||
          (e.ctrlKey && e.shiftKey && ["I", "J", "C"].includes(e.key)) ||
          (e.ctrlKey && ["U", "S"].includes(e.key))
        ) {
          e.preventDefault();
          e.stopPropagation();
          return false;
        }
      });

      let devtoolsOpen = false;

      setInterval(() => {
        const threshold = 160;
        const widthThreshold =
          window.outerWidth - window.innerWidth > threshold;
        const heightThreshold =
          window.outerHeight - window.innerHeight > threshold;

        if ((widthThreshold || heightThreshold) && !devtoolsOpen) {
          devtoolsOpen = true;
          isSuspicious = 3;

          // Optional: Close the tab immediately
          // window.open('', '_self');
          // window.close();

          // Or just log it
          console.warn("DevTools detected");
        }
      }, 1000);

      // Detect tab switch
      document.addEventListener("visibilitychange", () => {
        if (monitoringStarted && document.hidden) {
          isSuspicious = 1;
        }
      });
      async function getMonitorCount() {
        if ("getScreens" in navigator) {
          try {
            const screensInfo = await navigator.getScreens();
            return screensInfo.screens.length;
          } catch (err) {
            console.warn("Screen enumeration error:", err);
            return 1; // fallback
          }
        } else {
          console.warn("Screen Enumeration not supported");
          return 1;
        }
      }

      window.addEventListener("blur", () => {
        if (remainingSeconds < examTime - 40) {
          isSuspicious = 2;
        }
      });

      document.getElementById("startBtn").onclick = async () => {
        const emailInput = document.getElementById("email");
        const userId = emailInput.value.trim();

        if (!userId || !userId.includes("@")) {
          alert("Please enter a valid email address.");
          return;
        }

        try {
          const stream = await navigator.mediaDevices.getDisplayMedia({
            video: true,
          });

          const screenCount = await getMonitorCount();
          if (screenCount > 1) {
            alert(
              "Please disconnect additional monitors before starting the exam."
            );
            stream.getTracks().forEach((track) => track.stop()); // stop screen share
            return;
          }
          // detect multiple screens

          // ðŸ•µï¸â€â™‚ï¸ Keep checking screen count every 5 seconds

          // Show exam
          document.getElementById("startBtn").style.display = "none";
          document.getElementById("email").style.display = "none";
          document.querySelector("h2").style.display = "none";
          document.getElementById("examContainer").style.display = "block";
          monitoringStarted = true;

          socket.emit("user-join", userId);

          // Recording setup
          const video = document.createElement("video");
          video.srcObject = stream;
          video.play();

          const canvas = document.createElement("canvas");
          canvas.width = 426;
          canvas.height = 240;
          const ctx = canvas.getContext("2d");
          const draw = () =>
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

          const interval = setInterval(draw, 1000 / 5);
          const recordedStream = canvas.captureStream(5);
          const recorder = new MediaRecorder(recordedStream);

          recorder.ondataavailable = (e) => {
            if (e.data.size > 0) {
              e.data.arrayBuffer().then((buffer) => {
                socket.emit("video-chunk", { userId, chunk: buffer });
              });
            }
          };

          recorder.start(1000);

          // Timer setup
          const timerEl = document.getElementById("timer");

          const updateTimer = () => {
            const minutes = Math.floor(remainingSeconds / 60);
            const seconds = remainingSeconds % 60;
            timerEl.textContent = `Time Left: ${minutes}:${seconds
              .toString()
              .padStart(2, "0")}`;
          };

          updateTimer();

          const countdown = setInterval(() => {
            remainingSeconds--;
            updateTimer();
            if (remainingSeconds <= 0) {
              clearInterval(countdown);
              recorder.stop();
              clearInterval(interval);
              socket.emit("user-suspicion", { userId, isSuspicious });
              window.open("", "_self");
              window.close();
            }
          }, 1000);

          // count screens every 5 seconds
          setInterval(async () => {
            const screenCountNow = await getMonitorCount();
            if (screenCountNow > 1) {
              window.open("", "_self");
              window.close();
            }
          }, 5000);

          // Clean up on close
          window.addEventListener("beforeunload", () => {
            socket.emit("user-suspicion", { userId, isSuspicious });
            recorder.stop();
            clearInterval(interval);
          });
        } catch (err) {
          alert("Screen sharing is required to start the exam.");
        }
      };
    </script>
  </body>
</html>
